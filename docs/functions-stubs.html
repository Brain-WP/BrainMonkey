<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Giuseppe Mazzapica">
    <title>PHP Functions / Bulk patching with stubs(). Brain Monkey</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300|Source+Code+Pro:400' rel='stylesheet' type='text/css'>
    <link href="https://brain-wp.github.io/BrainMonkey/css/theme.min.css" rel="stylesheet">
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <div id="wrapper">

      <!-- Sidebar -->
      <div id="sidebar-wrapper">

          <div class="logo">
              <a href="https://brain-wp.github.io/BrainMonkey">
                <img src="https://brain-wp.github.io/BrainMonkey/images/brain-monkey-80.png" alt="Brain Monkey">
                <span>Brain Monkey</span>
              </a>
          </div>

          <ul class="sidebar-nav">
                                                  <li>
                        <a class="section" href="#sidebar-wrapper"><i class="fa fa-caret-right"></i> Getting Started</a>
                        <ul>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/installation.html">
                                        Installation
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/what-and-why.html">
                                        What & Why
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <a class="section" href="#sidebar-wrapper"><i class="fa fa-caret-right"></i> PHP Functions</a>
                        <ul>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/functions-setup.html">
                                        Setup
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/functions-when.html">
                                        Patching with when()
                                    </a>
                                </li>
                                                            <li class="active">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/functions-stubs.html">
                                        Bulk patching with stubs()
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/functions-expect.html">
                                        Testing with expect()
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <a class="section" href="#sidebar-wrapper"><i class="fa fa-caret-right"></i> WordPress</a>
                        <ul>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/wordpress-why-bother.html">
                                        Why Bother
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/wordpress-setup.html">
                                        Setup
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/wordpress-tools.html">
                                        WordPress Testing Tools
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/wordpress-hooks-added.html">
                                        Testing Added Hooks
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/wordpress-hooks-done.html">
                                        Testing Fired Hooks
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                    <li>
                        <a class="section" href="#sidebar-wrapper"><i class="fa fa-caret-right"></i> Migration</a>
                        <ul>
                                                            <li class="">
                                    <a href="https://brain-wp.github.io/BrainMonkey/docs/migrating-from-v1.html">
                                        Migrating From Version 1
                                    </a>
                                </li>
                                                    </ul>
                    </li>
                                        </ul>

      </div>
      <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper" class="content-wrapper-">
            <div class="container-fluid">
                <div class="row">
                    <div id="content" class="col-lg-11">
                                                                                <ol class="breadcrumb">
                              <li><a href="https://brain-wp.github.io/BrainMonkey">Brain Monkey</a></li>
                              <li class="active">PHP Functions</li>
                            </ol>
                                                                                                        <h1 id="bulk-patching-with-stubs">Bulk patching with stubs()</h1>
<p><code>when()</code> and its related methods are quite simple and straightforward.</p>
<p>However, it can be quite verbose when multiple functions needed to be patched.</p>
<p>When one uses <code>when()</code> they are not interested in adding expectations but usually are
interested in ensuring the target function is defined, and maybe its return value.</p>
<p>For this reason, version 2.1 introduced a new API function to define multiple functions in bulk: <code>stubs()</code></p>
<h2><code>stubs()</code></h2>
<p><code>Functions\stubs()</code> accepts an array of functions to be defined.</p>
<p>The function names can be passed as array item <em>keys</em> or as array item <em>values</em> and no key.</p>
<p>When the function name is the item key, the item value can be either:</p>
<ul>
<li>a <code>callable</code>, in which case the function will be aliased to it</li>
<li>anything else, in which case a stub returning given value will be created for the function</li>
</ul>
<p>Example:</p>
<pre><code class="language-php">Functions\stubs([
    'is_user_logged_in'   =&gt; true,
    'current_user_can'    =&gt; true,
    'wp_get_current_user' =&gt; function() {
        return \Mockery::mock('\WP_User');
    }
]);</code></pre>
<p>When the function name is the array item value, and no item key is used, the behavior will change
based on the second argument passed to <code>stubs()</code>:</p>
<ul>
<li>when 2nd argument is <code>null</code> (default), the created stub will return the 1st param it will receive</li>
<li>when 2nd argument is anything else the created stub will use it as its return value</li>
</ul>
<p>Example:</p>
<pre><code class="language-php">// Given functions will return `true`
Functions\stubs(
    [
        'is_user_logged_in',
        'current_user_can',
    ],
    true
);

// Given functions will return the first argument they will receive,
// just like `when( $function_name )-&gt;justReturnArg()` was used for all of them.
Functions\stubs(
   [
        'esc_attr',
        'esc_html',
        'esc_textarea',
        '__',
        '_x',
        'esc_html__',
        'esc_html_x',
        'esc_attr_x',
   ]
);</code></pre>
<h2 id="gotcha">Gotcha</h2>
<p>When passing to <code>stubs()</code> a function name as array item key and a <code>callable</code> as value, the function
will be aliased to that callable. It means that using <code>stubs()</code> is <strong>not</strong> possible to create a stub
for a function that returns a callback by doing something like:</p>
<pre><code class="language-php">Functions\stubs(
   [ 
        'function_that_returns_a_callback' =&gt; 'the_expected_returned_callback'
   ]
);</code></pre>
<p>But:</p>
<pre><code class="language-php">Functions\stubs(
   [
        'function_that_returns_a_callback' =&gt; function() { 
            return 'the_expected_returned_callback';
        }
   ]
);</code></pre>
<p>will work.</p>
<p>Moreover, when doing something like this:</p>
<pre><code class="language-php">Functions\stubs(
   [ 'function_that_returns_null' =&gt; null ]
);</code></pre>
<p>or like this:</p>
<pre><code class="language-php">Functions\stubs(
   [ 'function_that_returns_null' ],
   null
);</code></pre>
<p>the return value of the stub will <strong>not</strong> be <code>null</code>, because when return value is set to <code>null</code>
Brain Monkey will make the function stub return the first received value.</p>
<p>The only way to use <code>stubs()</code> for creating a stub that returns <code>null</code> is:</p>
<pre><code class="language-php">Functions\stubs(
   [ 'function_that_returns_null' =&gt; function() { return null; } ]
);</code></pre>
<p>or the equivalent but more concise:</p>
<pre><code class="language-php">// __return_null is defined by Brain Monkey since version 2
Functions\stubs( [ 'function_that_returns_null' =&gt; '__return_null' ] );</code></pre>
                                            </div>
                </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

                    <a href="https://github.com/Brain-WP/BrainMonkey">
                <img style="position:fixed; top:0; right:0; border:0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
            </a>
                <a href="#" id="menu-toggle" title="Toggle Menu"><i class="fa fa-bars"></i></a>


    </div>
    <!-- /#wrapper -->

    <footer class="footer hidden-xs hidden-sm">
      Made by hands by
      <a href="https://gmazzap.me/" title="Giuseppe Mazzapica Home Page" target="_blank">Giuseppe Mazzapica</a>, with
      <a href="http://couscous.io/" title="Couscous" target="_blank">Couscous</a>,
      <a href="https://getbootstrap.com/" title="Bootstrap" target="_blank">Bootstrap</a> &amp;
      <a href="https://highlightjs.org/" title="highlight.js" target="_blank">highlight.js</a>

      <span class="socials">
        <a href="https://github.com/gmazzap" title="GitHub" target="_blank"><i class="fa fa-github-alt"></i></a>
        <a href="https://twitter.com/gmazzap" title="Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
        <a href="https://wordpress.stackexchange.com/users/35541/" title="Stack Exchange" target="_blank"><i class="fa fa-stack-exchange"></i></a>
      </span>

    </footer>

    <a href="#wrapper" class="hidden-xs hidden-sm" id="back-top" title="Back to top"><i class="fa fa-long-arrow-up"></i></a>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://brain-wp.github.io/BrainMonkey/js/theme.min.js"></script>
    </body>

</html>
